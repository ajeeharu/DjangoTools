{% extends 'base_accounting.html' %}
{% block title %}公民館ツール：経理{%endblock %}
{% block content %}
{% load static %}
<div id="content">
  <section class="bg-white relative">
    <div class="grid grid-cols-4 py-2 px-4 mx-auto justify-items-center">
      <div
        class="text-2xl font-extrabold tracking-tight leading-none text-gray-600"
      >
        {{ user.public_hall.name }}公民館
      </div>
      <!-- メッセージ -->
      <div>
        {% if messages %}
        <div
          class="bg-gray-50 border border-red-300 text-red-600 text-sm rounded-lg block p-2.5"
        >
          {% for message in messages %} {{ message }} {% endfor%}
        </div>
        {% endif %}
      </div>
      <!--収入合計-->
      <div class="flex justify-between items-center w-52">
        <div class="text-xl">収入合計：</div>
        <div class="text-xl text-gray-500" id="income_total"></div>
      </div>
      <!--収入伝票-->
      <div class="space-y-2 flex items-center justify-items-center">
        <button
          type="button"
          id="open-window-income-create"
          class="inline-flex justify-center items-center p-2 text-xs font-medium text-center text-white rounded-lg bg-blue-500 hover:bg-blue-600 focus:ring-4 focus:ring-blue-300"
        >
          収入伝票作成
        </button>
      </div>
      <!--会計年度-->
      <div class="max-w-sm">
        <select
          id="select_fiscal_terms"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2"
        >
          <option selected value="none">会計年度選択</option>
          {% for fiscal_term in fiscal_term_objects %}
          <option value="{{ fiscal_term.id }}">{{ fiscal_term.name }}</option>
          {% endfor%}
        </select>
      </div>
      <!--現金出納帳-->
      <div class="max-w-sm">
        <select
          id="select_accounting_book"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2"
        >
          <option selected value="none">出納帳選択</option>
          {% for accounting_book in accounting_book_objects %}
          <option value="{{ accounting_book.id }}">{{ accounting_book.name }}</option>
          {% endfor%}
        </select>
      </div>
      <!--支出合計-->
      <div class="flex justify-between items-center w-52">
        <div class="text-xl">支出合計：</div>
        <div class="text-xl text-gray-500" id="spending_total"></div>
      </div>
      <!--支出伝票-->
      <div class="space-y-2 flex items-center justify-items-center">
        <button
          type="button"
          id="open-window-spending-create"
          class="inline-flex justify-center items-center p-2 text-xs font-medium text-center text-white rounded-lg bg-red-500 hover:bg-red-600 focus:ring-4 focus:ring-red-300"
        >
          支出伝票作成
        </button>
      </div>
    </div>
    <!-- プルダウンコンテンツ -->
    <button
      type="button"
      data-dropdown-toggle="dropdownAccountingDetail"
      class="dropdownbutton text-xs text-gray-500 hover:text-gray-500 font-medium rounded-lg px-5 py-1 absolute right-2 top-2"
    >
      詳細
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
      >
        <path
          fill="none"
          stroke="currentColor"
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="1.5"
          d="m7 10l5 5l5-5"
        />
      </svg>
    </button>
    {% comment %} <div
      id="dropdownAccountingDetail"
      class="dropdownmenu z-10 hidden border-t border-dotted border-gray-400"
    >
      <div class="grid grid-cols-4 py-2 px-4 mx-auto justify-items-center">
        <div
          class="text-2xl font-extrabold tracking-tight leading-none text-gray-600"
        >
          {{ user.public_hall.name }}公民館
        </div>
        <!-- メッセージ -->
        <div>
          {% if messages %}
          <div
            class="bg-gray-50 border border-red-300 text-red-600 text-sm rounded-lg block p-2.5"
          >
            {% for message in messages %} {{ message }} {% endfor%}
          </div>
          {% endif %}
        </div>
        <!--収入合計-->
        <div class="flex justify-between items-center w-52">
          <div class="text-xl">収入合計：</div>
          <div class="text-xl text-gray-500">￥12,423</div>
        </div>
        <!--収入伝票-->
        <div class="space-y-2 flex items-center justify-items-center">
          <button
            type="button"
            data-modal-target="#create-modal"
            data-modal-toggle="authentication-modal"
            data-modal-id="0"
            class="modal-open-button inline-flex justify-center items-center p-2 text-xs font-medium text-center text-white rounded-lg bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300"
          >
            収入伝票作成
          </button>
        </div>
        <!--会計年度-->
        <form class="max-w-sm">
          <select
            id="fiscal_terms"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2"
          >
            <option selected>会計年度選択</option>
            {% for fiscal_term in fiscal_term_objects %}
            <option value="{{ fiscal_term.id }}">{{ fiscal_term.name }}</option>
            {% endfor%}
          </select>
        </form>
        <!--現金出納帳-->
        <form class="max-w-sm">
          <select
            id="accountign_book"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2"
          >
            <option selected>出納帳選択</option>
            <option value="US">あめりか</option>
            <option value="CA">Canada</option>
            <option value="FR">France</option>
            <option value="DE">Germany</option>
          </select>
        </form>
        <!--支出合計-->
        <div class="flex justify-between items-center w-52">
          <div class="text-xl">支出合計：</div>
          <div class="text-xl text-gray-500">￥123,423</div>
        </div>
        <!--支出伝票-->
        <div class="space-y-2 flex items-center justify-items-center">
          <button
            type="button"
            data-modal-target="#create-modal"
            data-modal-toggle="authentication-modal"
            data-modal-id="0"
            class="modal-open-button inline-flex justify-center items-center p-2 text-xs font-medium text-center text-white rounded-lg bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300"
          >
            支出伝票作成
          </button>
        </div>
      </div>
    </div> {% endcomment %}
  </section>

  <div class="max-w-6xl relative overflow-x-auto mx-auto">
    <table
      class="w-full text-xs text-center rtl:text-right text-gray-500 border-gray-500 border-x border-solid"
    >
      <thead class="text-gray-700">
        <tr class="border-gray-500 border-y border-solid bg-gray-200">
          <th
            scope="col"
            class="border-gray-500 border-x border-solid p-1 w-16"
          >
            debug
          </th>
          <th
            scope="col"
            class="border-gray-500 border-x border-solid p-1 w-16"
          >
            詳細<br />変更
          </th>
          <th
            scope="col"
            class="border-gray-500 border-x border-solid p-1 w-16"
          >
            番号<br />固定
          </th>
          <th scope="col" class="border-gray-500 border-x border-solid p-1 w-8">
            月
          </th>
          <th scope="col" class="border-gray-500 border-x border-solid p-1 w-8">
            日
          </th>
          <th scope="col" class="border-gray-500 border-x border-solid p-1 w-8">
            項<br />(目)
          </th>
          <th scope="col" class="border-gray-500 border-x border-solid p-1 w-8">
            目<br />(節)
          </th>
          <th
            scope="col"
            class="border-gray-500 border-x border-solid p-1 w-40"
          >
            債権者<br />納入者
          </th>
          <th
            scope="col"
            class="border-gray-500 border-x border-solid px-6 py-2"
          >
            概　要
          </th>
          <th
            scope="col"
            class="border-gray-500 border-x border-solid p-1 w-16"
          >
            収入<br />番号
          </th>
          <th
            scope="col"
            class="border-gray-500 border-x border-solid p-1 w-16"
          >
            支出<br />番号
          </th>
          <th
            scope="col"
            class="border-gray-500 border-x border-solid px-6 py-2 w-32"
          >
            収入金額
          </th>
          <th
            scope="col"
            class="border-gray-500 border-x border-solid px-6 py-2 w-32"
          >
            支出金額
          </th>
          <th
            scope="col"
            class="border-gray-500 border-x border-solid px-6 py-2 w-32"
          >
            差引残高
          </th>
          <th scope="col" class="border-gray-500 border-x border-solid p-1 w-8">
            見<br />積
          </th>
          <th scope="col" class="border-gray-500 border-x border-solid p-1 w-8">
            領<br />収
          </th>
        </tr>
      </thead>
      <tbody id="AccountingList" class="text-xs">
      </tbody>
    </table>
    <div class="hidden bg-red-100 border border-red-400 text-2xl text-red-700 px-4 py-3 mt-8 rounded font-bold" role="alert" id="warning_message">
    </div>
  </div>
</div>
<script src="{% static 'js/Sortable.js' %}"></script>
<script type="text/javascript">
  let spending_amount_total = 0;        // 支出合計
  let income_amount_total = 0;          // 収入合計
  let pagedata_json;                    // 表示ページ情報
  const element_tbody = document.querySelector('#AccountingList');

//  Description ： 表示初期化
  const InitPage =() =>{
    spending_amount_total = 0;        // 支出合計
    income_amount_total = 0;          // 収入合計
    while(element_tbody.firstChild){
      element_tbody.removeChild(element_tbody.firstChild);
    }
  }
//  Description ： レンダリング
  const RenderingPage =( result )=>{
  // 表示を初期化
    InitPage();

    for(let i=0; i<result.length; i++){
      let data=result[i];

      let tr_element = document.createElement("tr");
      tr_element.className = "border-gray-500 border-y border-solid";
// データ（シリアルNo.）
      let debug_element = document.createElement("td");
      debug_element.className ="border-gray-500 border-x border-solid text-center data-serial-number";
      debug_element.textContent = data.number;
      tr_element.appendChild(debug_element);
// Update用のModalボタン
      let td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-center";

      let button_element = document.createElement("button");
      button_element.type="button";
      button_element.className = "modal-open-button font-medium text-blue-600 mx-auto";
      button_element.setAttribute("data-modal-hide","authentication-modal");
      button_element.setAttribute("data-modal-target","#update-modal");
      button_element.setAttribute("data-id",data.id);

      let href_element = document.createElement("a");
      href_element.href = "#";
      href_element.innerHTML=
            '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">'
            +'<path fill="currentColor" d="m18.988 2.012l3 3L19.701 7.3l-3-3zM8 16h3l7.287-7.287l-3-3L8 13z"/>'
            +'<path fill="currentColor"'
            +'d="M19 19H8.158c-.026 0-.053.01-.079.01c-.033 0-.066-.009-.1-.01H5V5h6.847l2-2H5c-1.103 0-2 .896-2 2v14c0 1.104.897 2 2 2h14a2 2 0 0 0 2-2v-8.668l-2 2z"'
            +'/>'
            +'</svg>';
      button_element.appendChild(href_element);
      td_element.appendChild(button_element);
      tr_element.appendChild(td_element);

// 番号固定
      td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-center";

      button_element = document.createElement("button");
      button_element.type="button";
      button_element.className = "font-medium text-gray-500 mx-auto";
      if((( data.income_select.value=="支出命令")&&( data.spending_record.fixed_number ))
        ||(( data.income_select.value!="支出命令")&&( data.income_record.fixed_number ))){
        button_element.innerHTML =
            '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">'
            +'<path fill="currentColor"'
            +   'd="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 16H5V5h14zM17.99 9l-1.41-1.42l-6.59 6.59l-2.58-2.57l-1.42 1.41l4 3.99z"'
            +'/>'
            +'</svg>';
      }else{
        button_element.innerHTML =
            '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">'
            +'<path fill="currentColor" d="M3 21V3h18v18zm2-2h14V5H5zm0 0V5z" />'
            +'</svg>';
      }
      td_element.appendChild(button_element);
      tr_element.appendChild(td_element);
//月
      td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-center";
      let month;
      if( data.income_select.value=="支出命令")
      {
        td_element.textContent = data.spending_record.date.substring(5,7);
      }else
      {
        td_element.textContent = data.income_record.date.substring(5,7);
      }
      tr_element.appendChild(td_element);

//日
      td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-center";
      if( data.income_select.value=="支出命令")
      {
        td_element.textContent = data.spending_record.date.substring(8,10);
      }else
      {
        td_element.textContent = data.income_record.date.substring(8,10);
      }
      tr_element.appendChild(td_element);
//項
      td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-center";
      if( data.income_select.value=="支出命令")
      {
        td_element.textContent = data.spending_record.subject_spending.acronym;
      }else
      {
        td_element.textContent = data.income_record.subject_income.acronym;
      }
      tr_element.appendChild(td_element);
//節
      td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-center";
      if( data.income_select.value=="支出命令")
      {
        td_element.textContent = data.spending_record.section_spending.acronym;
      }else
      {
        td_element.textContent = data.income_record.section_income.acronym;
      }
      tr_element.appendChild(td_element);
//債権者・納入者
      td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-center";
      if( data.income_select.value=="支出命令")
      {
        td_element.textContent = data.spending_record.creditor.name;
      }else
      {
        td_element.textContent = data.income_record.supplier.name;
      }
      tr_element.appendChild(td_element);
//概要
      td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-center";
      if( data.income_select.value=="支出命令")
      {
        td_element.textContent = data.spending_record.description;
      }else
      {
        td_element.textContent = data.income_record.description;
      }
      tr_element.appendChild(td_element);
//収入番号
      td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-center";
      if( data.income_select.value=="支出命令")
      {
      }else
      {
        td_element.textContent = data.income_record.number;
      }
      tr_element.appendChild(td_element);
//支出番号
      td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-center";
      if( data.income_select.value=="支出命令")
      {
        td_element.textContent = data.spending_record.number;
      }else
      {
      }
      tr_element.appendChild(td_element);
//収入金額
      td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-right pr-1 text-xs";
      if( data.income_select.value=="支出命令")
      {
      }else
      {
        td_element.textContent = data.income_record.amount.toLocaleString('ja-JP', {style:'currency', currency: 'JPY'});
        income_amount_total += data.income_record.amount;
      }
      tr_element.appendChild(td_element);
//支出金額
      td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-right pr-1 text-xs";
      if( data.income_select.value=="支出命令")
      {
        td_element.textContent = data.spending_record.amount.toLocaleString('ja-JP', {style:'currency', currency: 'JPY'});
        spending_amount_total += data.spending_record.amount;
      }else
      {
      }
      tr_element.appendChild(td_element);
//差引残高
      td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-right pr-1 text-xs";
      td_element.textContent = (income_amount_total-spending_amount_total).toLocaleString('ja-JP', {style:'currency', currency: 'JPY'});
      tr_element.appendChild(td_element);
//見積もり
      td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-center";
      if( data.income_select.value=="支出命令")
      {
        if(data.spending_record.estimate != null){
          button_element = document.createElement("button");
          button_element.type="button";
          button_element.className = "font-medium text-gray-500 mx-auto";
          href_element = document.createElement("a");
          href_element.href = data.spending_record.estimate;
          href_element.innerHTML=
              '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">'
              +'<path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8zm4 18H6V4h7v5h5z"/>'
              +'</svg>';
          button_element.appendChild(href_element);
          td_element.appendChild(button_element);
        }
      }else
      {
        if(data.income_record.notice1 != null){
          button_element = document.createElement("button");
          button_element.type="button";
          button_element.className = "font-medium text-gray-500 mx-auto";
          href_element = document.createElement("a");
          href_element.href = data.income_record.notice1;
          href_element.innerHTML=
              '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">'
              +'<path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8zm4 18H6V4h7v5h5z"/>'
              +'</svg>';
          button_element.appendChild(href_element);
          td_element.appendChild(button_element);
        }
      }
      tr_element.appendChild(td_element);
//領収
      td_element = document.createElement("td");
      td_element.className ="border-gray-500 border-x border-solid text-center";
      if( data.income_select.value=="支出命令")
      {
        if(data.spending_record.receipt != null){
          button_element = document.createElement("button");
          button_element.type="button";
          button_element.className = "font-medium text-gray-500 mx-auto";
          href_element = document.createElement("a");
          href_element.href = data.spending_record.receipt;
          href_element.innerHTML=
              '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">'
              +'<path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8zm4 18H6V4h7v5h5z"/>'
              +'</svg>';
          button_element.appendChild(href_element);
          td_element.appendChild(button_element);
        }
      }else
      {
        if(data.income_record.notice2 != null){
          button_element = document.createElement("button");
          button_element.type="button";
          button_element.className = "font-medium text-gray-500 mx-auto";
          href_element = document.createElement("a");
          href_element.href = data.income_record.notice2;
          href_element.innerHTML=
              '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">'
              +'<path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8zm4 18H6V4h7v5h5z"/>'
              +'</svg>';
          button_element.appendChild(href_element);
          td_element.appendChild(button_element);
        }
      }
      tr_element.appendChild(td_element);
// tr（1行）書き込み
      element_tbody.appendChild(tr_element);
    }
  };

//  Description ： PageManagerの番号のDBへのUpdate処理(PATCH)
  const PageManagerPatchNumber = async(id, number)=>
  {
    try {
    // API経由でData取得
      const CreateEndPoint ="/api/accounting/pagemanager/"+id+"/";
      let response = await fetch(CreateEndPoint, {
        method: 'PATCH',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          number: number
        }),
      });
      let result = await response.json();
    }catch(error){
      console.error("PATCH API通信エラーが発生しました,error");
    }
  };

//  Description ： 収入番号のDBへのUpdate処理(PATCH)
  const IncomeRecordPatchNumber = async(id, number)=>
  {
    try {
    // API経由でData取得
      const CreateEndPoint ="/api/accounting/incomerecord/"+id+"/";
      let response = await fetch(CreateEndPoint, {
        method: 'PATCH',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          number: number
        }),
      });
      let result = await response.json();
    }catch(error){
      console.error("PATCH API通信エラーが発生しました,error");
    }
  };

//  Description ： 支出番号のDBへのUpdate処理(PATCH)
  const SpendingRecordPatchNumber = async(id, number)=>
  {
    try {
    // API経由でData取得
      const CreateEndPoint ="/api/accounting/spendingrecord/"+id+"/";
      let response = await fetch(CreateEndPoint, {
        method: 'PATCH',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          number: number
        }),
      });
      let result = await response.json();
    }catch(error){
      console.error("PATCH API通信エラーが発生しました,error");
    }
  };

//  Description ： PageManagerのシリアル番号を整理する。
//  return ： true(変更有)/false(変更なし)
  const CheckPageNumber = async(result) =>{
    let retry = false;
    let page_counter =1;

    for(let i=0; i<result.length; i++){
      let data=result[i];
      // PageManagerのSerialNo.がずれていたらReNumber
      if( page_counter != data.number )
      {
        await PageManagerPatchNumber(data.id, page_counter);
        retry = true;
      }
      page_counter++;
    }
    return retry;
  }

//  Description ： 収入番号を整理する。
//  return ： true(変更有)/false(変更なし)
  const CheckIncomeNumber = async(result) =>{
    let retry = false;
    let income_counter =1;

    for(let i=0; i<result.length; i++){
      let data=result[i];
      // 番号固定でなければ支出番号、収入番号をチェック
      if(( data.income_select.value!="支出命令")&&( !data.income_record.fixed_number ))
      {
        if( income_counter != data.income_record.number )
        {
          await IncomeRecordPatchNumber(data.income_record.id, income_counter);
          retry = true;
        }
        income_counter++;
      }
    }
    return retry;
  }

//  Description ： 支出番号を整理する。
//  return ： true(変更有)/false(変更なし)
  const CheckSpendingNumber = async(result) =>{
    let retry = false;
    let spending_counter =1;

    for(let i=0; i<result.length; i++){
      let data=result[i];
      if(( data.income_select.value=="支出命令")&&( !data.spending_record.fixed_number ))
      {
        if( spending_counter != data.spending_record.number )
        {
          await SpendingRecordPatchNumber(data.spending_record.id, spending_counter);
          retry = true;
        }
        spending_counter++;
      }
    }
    return retry;
  }


//  Description ： 出納帳、期間よりDBからPage情報を取得（番号の整理も行う。）
  const PageManagerList = async(fiscal_terms,accounting_book) =>
  {
    try {
    // API経由でData取得
      const CreateEndPoint ="/api/accounting/pagemanager/?accounting_book="+accounting_book+"&fiscal_terms="+fiscal_terms;
      let response = await fetch(CreateEndPoint, {
        method: 'GET',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json',
        }
      });
      let result = await response.json(); // 読み込むのはJSON部分（ヘッダー等は削除）
      let retry = await CheckPageNumber(result);
      retry |= await CheckSpendingNumber(result);
      retry |= await CheckIncomeNumber(result);
      if( retry )
      {
        return await PageManagerList(fiscal_terms_value,accounting_book_value);
      }
      RenderingPage( result );
      SetTotalAmount();
      pagedata_json = result;
    }catch(error){
      console.error("GET API通信エラーが発生しました,error");
    }
  };

//  Description ： PageManagerのList順番を変更
  const PageManagerRenumber = async(result) =>
  {
      await CheckPageNumber(result);
      await CheckSpendingNumber(result);
      await CheckIncomeNumber(result);
      PageManagerList(fiscal_terms_value,accounting_book_value);
  };



  const onEndEvent = (event) => {
    // console.log("onEnd!!");
    let elements_serial = document.querySelectorAll('.data-serial-number');
    let result= new Array();

    for( i =0; i <elements_serial.length; i++)
    {
      result[i] = pagedata_json[elements_serial[i].textContent-1];
    }
    PageManagerRenumber(result);
    // console.log( result );
  };

  new Sortable(AccountingList, {
    multiDrag: true,            // Enable multi-drag
    selectedClass: "selected",  // The class applied to the selected items
    fallbackTolerance: 3,       // So that we can select items on mobile
    animation: 150,
//    onStart: onStartEvent,      // 2-1, ドラッグ開始時
    onEnd: onEndEvent,          // 2-2, ドラッグ終了時
//    onChange: onChangeEvent,    // 2-3, ドラッグ変化時
//    onSort: onSortEvent,        // 2-4, 並び替え終了時
  });


   // Warning Message
  const element_warning_message = document.querySelector('#warning_message');

  // 会計年度と出納帳の選択状況
  const element_fiscal_terms = document.querySelector('#select_fiscal_terms');
  const element_accounting_book = document.querySelector('#select_accounting_book');
  const element_income_total = document.querySelector('#income_total');
  const element_spendign_total = document.querySelector('#spending_total');

  let  fiscal_terms_value = 'none';
  let  accounting_book_value = 'none';

  const SetTotalAmount =()=>{
    element_spendign_total.textContent = spending_amount_total.toLocaleString('ja-JP', {style:'currency', currency: 'JPY'});
    element_income_total.textContent = income_amount_total.toLocaleString('ja-JP', {style:'currency', currency: 'JPY'});
  }

  const SetPageListAndWarning =()=>{
    if (fiscal_terms_value=='none'){
      element_warning_message.textContent ="会計年度を選択してください！";
      element_warning_message.classList.remove("hidden");
      InitPage();
      SetTotalAmount();
    }else if(accounting_book_value=='none'){
      element_warning_message.textContent ="出納帳を選択してください！";
      element_warning_message.classList.remove("hidden");
      InitPage();
      SetTotalAmount();
    }else{
      element_warning_message.textContent ="";
      element_warning_message.classList.add("hidden");
      PageManagerList(fiscal_terms_value,accounting_book_value);
      // SetTotalAmount(); 非同期のためPageManagerList内で同期待ち合わせ
    }
    // URLを変更
    history.pushState("", "", "?accounting_book="+accounting_book_value+"&fiscal_terms="+fiscal_terms_value);
  }

  document.addEventListener("DOMContentLoaded", () => {
    fiscal_terms_value = 'none';
    accounting_book_value = 'none';
    // URLを取得
    let url = new URL(window.location.href);
    // URLSearchParamsオブジェクトを取得
    let params = url.searchParams;

    if( params.get('fiscal_terms') != null )
    {
      fiscal_terms_value = params.get('fiscal_terms');
    }
    if( params.get('accounting_book') != null )
    {
      accounting_book_value = params.get('accounting_book');
    }
    SetSelect(element_fiscal_terms.options, fiscal_terms_value);
    SetSelect(element_accounting_book.options, accounting_book_value);
    SetPageListAndWarning();
    element_fiscal_terms.addEventListener("change", (event) => {
      fiscal_terms_value = event.target.value;
      SetPageListAndWarning();
    });
    element_accounting_book.addEventListener("change", (event) => {
      accounting_book_value = event.target.value;
      SetPageListAndWarning();
    });
  });

  // モーダル表示前のチェック
  const CheckAccountingBook =() =>{
    return ((fiscal_terms_value=='none')|| (accounting_book_value=='none'));
  }

  // 子Window制御
  const element_open_window_incomecreate= document.querySelector('#open-window-income-create');
  const element_open_window_spendingcreate= document.querySelector('#open-window-spending-create');
  document.addEventListener("DOMContentLoaded", () => {
    element_open_window_incomecreate.addEventListener("click", (event) => {
      if(!CheckAccountingBook()){
         let child_window = window.open("{% url 'accounting:create_incomerecord' %}"+"?fiscal_terms="+fiscal_terms_value+"&accounting_book="+accounting_book_value+"&record_number="+(pagedata_json.length + 1),"income_create_record", "width=896px");
        }
    });
    element_open_window_spendingcreate.addEventListener("click", (event) => {
      if(!CheckAccountingBook()){
         let child_window = window.open("{% url 'accounting:create_spendingrecord' %}"+"?fiscal_terms="+fiscal_terms_value+"&accounting_book="+accounting_book_value+"&record_number="+(pagedata_json.length + 1),"income_create_record", "width=896px");
        }
    });
  });

</script>


{% endblock %}
